<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Panel - Daily Holiday</title>
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 1000px;
      margin: 40px auto;
      background: #fff;
      border-radius: 10px;
      padding: 30px;
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      color: #0078FF;
    }
    h2 {
      color: #0078FF;
      border-bottom: 2px solid #0078FF;
      padding-bottom: 5px;
      margin-top: 40px;
    }
    label { display: block; margin-top: 15px; font-weight: 600; color: #333; }
    input[type="text"], input[type="email"], input[type="password"], textarea, input[type="file"] {
      width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ccc; margin-top: 5px;
    }
    button {
      background: #0078FF; color: #fff; border: none; padding: 10px 16px;
      border-radius: 8px; cursor: pointer; font-weight: bold; margin: 5px;
    }
    button:hover { background: #005dc5; }
    .danger { background: #e74c3c; }
    .danger:hover { background: #c0392b; }
    #preview { border: 2px dashed #0078FF; border-radius: 10px; padding: 20px; margin-top: 30px; background: #f8faff; }
    #preview img { max-width: 100%; border-radius: 10px; margin-bottom: 15px; }
    .article-list { margin-top: 20px; }
    .article-card {
      border: 1px solid #ccc; border-radius: 10px; padding: 15px; margin-bottom: 15px;
      background: #fdfdfd; display: flex; align-items: center; justify-content: space-between;
    }
    .article-card img { width: 100px; height: 70px; object-fit: cover; border-radius: 6px; margin-right: 15px; }
    .article-info { flex: 1; }
    #loginSection {
      max-width: 420px;
      margin: 12vh auto;
      background: #fff;
      padding: 40px 35px;
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
      text-align: center;
      border-top: 4px solid #0078FF;
    }
    
    #loginSection h2 {
      color: #0078FF;
      font-size: 1.6rem;
      margin-bottom: 25px;
      border-bottom: 2px solid #0078FF;
      display: inline-block;
      padding-bottom: 6px;
    }
    
    #loginSection label {
      display: block;
      text-align: left;
      margin-top: 15px;
      font-weight: 600;
      color: #333;
    }
    
    #loginSection input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 6px;
      font-size: 0.95rem;
      transition: all 0.2s ease-in-out;
    }
    
    #loginSection input:focus {
      border-color: #0078FF;
      box-shadow: 0 0 0 3px rgba(0, 120, 255, 0.1);
      outline: none;
    }
    
    #loginSection button {
      width: 100%;
      background: #0078FF;
      color: white;
      border: none;
      padding: 12px;
      margin-top: 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: background 0.2s ease-in-out;
    }
    
    #loginSection button:hover {
      background: #005dc5;
    }
    
    #loginError {
      color: #e74c3c;
      margin-top: 10px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <!-- 🔒 Login Section -->
  <div id="loginSection">
    <h2>Admin Login</h2>
    <label for="loginEmail">Email</label>
    <input type="email" id="loginEmail" placeholder="Enter your email" />
    <label for="loginPassword">Password</label>
    <input type="password" id="loginPassword" placeholder="Enter your password" />
    <button id="loginBtn">Login</button>
    <p id="loginError" style="color:red; display:none;"></p>
  </div>

  <!-- 🛠️ Admin Section -->
  <div class="container" id="adminSection" style="display:none;">
    <button id="logoutBtn">Logout</button>
    <h1>Daily Holiday Admin Panel</h1>

    <h2>Create New Article</h2>
    <label for="title">Article Title</label>
    <input type="text" id="title" placeholder="Enter article title" />

    <label for="summary">Summary</label>
    <textarea id="summary" rows="3" placeholder="Short summary (will show on homepage)"></textarea>

    <label for="imageInput">Upload Image (or paste Google Drive link below)</label>
    <input type="file" id="imageInput" accept="image/*" />
    <input type="text" id="imageLink" placeholder="Or paste Google Drive/share image link" />

    <label for="editor">Full Article Content</label>
    <div id="editor" style="height: 250px;"></div>

    <button id="publishBtn">Publish Article</button>

    <div id="preview">
      <h3>Live Preview</h3>
      <div id="previewContent"></div>
    </div>

    <h2>Manage Articles</h2>
    <div class="article-list" id="articleList">
      <p>Loading articles...</p>
    </div>
  </div>

  <!-- ✅ Firebase + Admin Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBS7C50eMiRtQ4nge4HrXo0ZuEkKoIVIUE",
      authDomain: "daily-holiday.firebaseapp.com",
      projectId: "daily-holiday",
      storageBucket: "daily-holiday.firebasestorage.app",
      messagingSenderId: "51054604621",
      appId: "1:51054604621:web:deffcd35458bb7c6b18704",
      measurementId: "G-SX1PV7VLSX"
    };

    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loginSection = document.getElementById('loginSection');
    const adminSection = document.getElementById('adminSection');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginError = document.getElementById('loginError');
    const articleList = document.getElementById('articleList');

    loginBtn.addEventListener('click', async () => {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
        loginError.style.display = 'none';
      } catch {
        loginError.textContent = "❌ Invalid email or password.";
        loginError.style.display = 'block';
      }
    });

    logoutBtn.addEventListener('click', () => signOut(auth));

    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginSection.style.display = 'none';
        adminSection.style.display = 'block';
        loadArticles();
      } else {
        loginSection.style.display = 'block';
        adminSection.style.display = 'none';
      }
    });

    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], [{ 'list': 'ordered' }, { 'list': 'bullet' }], [{ 'align': [] }], ['link', 'image', 'blockquote', 'code-block'], ['clean']] }
    });

    const titleInput = document.getElementById('title');
    const summaryInput = document.getElementById('summary');
    const imageInput = document.getElementById('imageInput');
    const imageLink = document.getElementById('imageLink');
    const publishBtn = document.getElementById('publishBtn');
    const previewContent = document.getElementById('previewContent');

    function normalizeDriveLink(url) {
      if (!url) return "";
      const match = url.match(/[-\w]{25,}/);
      return match ? `https://drive.google.com/uc?export=view&id=${match[0]}` : url;
    }

    function updatePreview() {
      const title = titleInput.value;
      const summary = summaryInput.value;
      const content = quill.root.innerHTML;
      const imageFile = imageInput.files[0];
      const driveLink = normalizeDriveLink(imageLink.value);
      let imgHTML = '';
      if (imageFile) imgHTML = `<img src="${URL.createObjectURL(imageFile)}">`;
      else if (driveLink) imgHTML = `<img src="${driveLink}">`;
      previewContent.innerHTML = `${imgHTML}<h4>${title}</h4><p><em>${summary}</em></p><div>${content}</div>`;
    }

    titleInput.addEventListener('input', updatePreview);
    summaryInput.addEventListener('input', updatePreview);
    imageInput.addEventListener('change', updatePreview);
    imageLink.addEventListener('input', updatePreview);
    quill.on('text-change', updatePreview);

    publishBtn.addEventListener('click', async () => {
      const title = titleInput.value.trim();
      const summary = summaryInput.value.trim();
      const content = quill.root.innerHTML;
      const imageFile = imageInput.files[0];
      const driveLink = normalizeDriveLink(imageLink.value);
      if (!title || !summary || !content) return alert("Please fill all fields.");

      let imageURL = "";
      publishBtn.disabled = true;
      publishBtn.textContent = "Uploading...";
      try {
        if (imageFile) {
          const storageRef = ref(storage, 'articles/' + imageFile.name);
          await uploadBytes(storageRef, imageFile);
          imageURL = await getDownloadURL(storageRef);
        } else if (driveLink) {
          imageURL = driveLink;
        }
        await addDoc(collection(db, "articles"), { title, summary, content, imageURL, createdAt: serverTimestamp() });
        alert("✅ Article published successfully!");
        titleInput.value = ""; summaryInput.value = ""; imageInput.value = ""; imageLink.value = ""; quill.root.innerHTML = ""; previewContent.innerHTML = "";
        loadArticles();
      } catch (err) {
        console.error(err); alert("❌ Error publishing article.");
      } finally {
        publishBtn.disabled = false;
        publishBtn.textContent = "Publish Article";
      }
    });

    async function loadArticles() {
      articleList.innerHTML = "<p>Loading...</p>";
      const snapshot = await getDocs(collection(db, "articles"));
      articleList.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const image = data.imageURL || "";
        const title = data.title || "";
        const summary = data.summary || "";
        const card = document.createElement('div');
        card.className = 'article-card';
        card.innerHTML = `
          <img src="${image}">
          <div class="article-info">
            <strong>${title}</strong>
            <p>${summary.substring(0, 60)}...</p>
          </div>
          <div>
            <button class="editBtn" data-id="${id}">Edit</button>
            <button class="danger deleteBtn" data-id="${id}">Delete</button>
          </div>`;
        articleList.appendChild(card);
      });

      // 🛠 Add button listeners after rendering
      document.querySelectorAll('.deleteBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (confirm("Delete this article?")) {
            await deleteDoc(doc(db, "articles", btn.dataset.id));
            loadArticles();
          }
        });
      });

      document.querySelectorAll('.editBtn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const docSnap = snapshot.docs.find(d => d.id === btn.dataset.id);
          if (!docSnap) return;
          const data = docSnap.data();
          titleInput.value = data.title || "";
          summaryInput.value = data.summary || "";
          quill.root.innerHTML = data.content || "";
          imageLink.value = data.imageURL || "";
          updatePreview();

          publishBtn.textContent = "Update Article";
          publishBtn.onclick = async () => {
            await updateDoc(doc(db, "articles", btn.dataset.id), {
              title: titleInput.value.trim(),
              summary: summaryInput.value.trim(),
              content: quill.root.innerHTML,
              imageURL: normalizeDriveLink(imageLink.value)
            });
            alert("✅ Article updated!");
            publishBtn.textContent = "Publish Article";
            publishBtn.onclick = null;
            titleInput.value = summaryInput.value = imageLink.value = "";
            quill.root.innerHTML = "";
            previewContent.innerHTML = "";
            loadArticles();
          };
        });
      });
    }
  </script>
  <script src="https://cdn.quilljs.com/1.3.7/quill.js"></script>
</body>
</html>
